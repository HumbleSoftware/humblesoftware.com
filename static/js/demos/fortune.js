//
// Fortune 500
// Copyright 2011 Humble Software Development
//
(function(){function r(){function s(a){return a<0?profit=Math.round(height/2+Math.log(-10*a)*b):profit=Math.round(height/2-Math.log(10*a)*b)}function r(b){return Math.round(height-Math.log(b-40)*a)}var a=height/Math.log(6e5),b=height/(2*Math.log(1e6)),c=j[g],d=j[e],f=j[i],h=F500.values,k=F500.inflation,l=h.length,m,n,o,p,q;for(p=0;p<l;p++){n=h[p],m=n.length;for(q=0;q<m;q++)o=n[q][f],n[q].push(r(n[q][c])),n[q].push(r(n[q][c]*k[o])),n[q].push(s(n[q][d])),n[q].push(s(n[q][d]*k[o]))}}function q(){vis.attr("width",width).attr("height",height),context.strokeStyle=b,context.lineWidth="1px"}function p(){function w(){p?(m=!0,clearTimeout(j),c?c+=.05:c=.05,k(type,(1+Math.sin(-Math.PI/2-c*Math.PI))/2),c<1?j=setTimeout(function(){w()},10):m=!1):k(type,1)}function v(a){b=type,type=a,c=0,m||w()}function u(a){var b=t(),c=[d,g,e],i;for(var j in c)if($(a.target).hasClass(c[j])){i=c[j];if(i===type)return;$(".controls .control").removeClass("selected"),$(a.target).addClass("selected"),b&&(i==g?i=h:i==e&&(i=f)),v(i);return}}function t(){return!!$("#inflation-checkbox").attr("checked")}function s(a){a?(selected=a,n(a.i,a.j),k(type,1)):(selected=null,company.hide(),k(type,1))}var b=null,c=0,j=null,m=!1,o=$(a),p,r;q(),r=new Date,k(d,1),p=new Date-r<150?!0:!1,$(".controls .control").click(u),$("#inflation-checkbox").change(function(a){var b=t();b?type==g?v(h):type==e&&v(f):type==h?v(g):type==f&&v(e)}),$(window).keydown(function(a){if(selected!==null){var b=F500.values,c=b[selected.i][selected.j],e=c[C_MAP[i]],f=c[C_MAP[d]],g;switch(a.keyCode){case 37:e-=14;break;case 38:f--;break;case 39:e+=14;break;case 40:f++;break;default:return}a.preventDefault(),g=l(d,e,f,!0),s(g);return!1}}),vis.click(function(a){var b=vis.offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=l(type,c,d);s(e)})}function o(a,b,c){var d=F500.values[a][b],e=C_MAP[type],f=d[C_MAP[i]],g=c*d[e]+(1-c)*(d.previous||0);company.css({left:f-company.width()/2,top:Math.round(g+4)})}function n(a,b){var c=F500.values[a][b],d=F500.names[a],e='<div class="company-content"><div class="value name">'+d+"</div>",f;for(f in j)e+='<div class="data '+f+'">',e+='<div class="label">'+f+"</div>",e+='<div class="value">'+(TRANSLATIONS[f]?TRANSLATIONS[f](c[j[f]]):c[j[f]])+"</div>",e+="</div>";e+='</div><div class="company-arrow"></div>',company.html(e).show()}function m(a,b,d){var e=F500.names[b.i],f=Math.max(e.length/4,3),g=F500.values[b.i],h=C_MAP[i],j=C_MAP[a],k,l,m;context.save(),context.strokeStyle=c,context.lineWidth="2.5",context.beginPath();for(m=0;m<g.length;m++)k=g[m][h],l=d*g[m][j]+(1-d)*(g[m].previous||g[m][b.i]),context.moveTo(k-f,l),context.lineTo(k+f,l);context.moveTo(g[0][h],g[0][j]),context.closePath(),context.stroke(),context.restore(),o(b.i,b.j,d)}function l(a,b,c,d){var e=C_MAP[i],f=C_MAP[a],g=F500.values,h=g.length,j,k,l,m;for(l=0;l<h;l++){k=g[l],j=k.length;if(d){for(m=0;m<j;m++)if(Math.abs(k[m][e]-b)<7&&k[m][f]==c)return{i:l,j:m}}else for(m=0;m<j;m++)if(Math.abs(k[m][e]-b)<7&&Math.abs(k[m][f]-c)<1)return{i:l,j:m}}}function k(a,b){var c=C_MAP[i],d=C_MAP[a],e=F500.names,f=F500.values,g=f.length,h,j,k,l,n,o,p;context.clearRect(0,0,width,height),context.beginPath();for(l=0;l<g;l++){j=f[l],h=j.length,k=e[l].length/4;for(n=0;n<h;n++)o=j[n][c],p=b*j[n][d]+(1-b)*(j[n].previous||j[n][d])-.5,context.moveTo(o-k,p),context.lineTo(o+k,p),j[n].previous=p}context.closePath(),context.stroke(),selected!==null&&m(a,selected,b)}var a="#chart",b="rgba(72,99,160,.8)",b="rgba(72,72,72,.8)",b="rgba(72,72,72,.3)",b="rgba(181,192,217,1)",c="rgba(200,30,30,1)",d="rank",e="profit",f="iProfit",g="revenue",h="iRevenue",i="year",j={year:0,rank:1,revenue:2,profit:3};C_MAP={year:0,rank:1,revenue:4,iRevenue:5,profit:6,iProfit:7},TRANSLATIONS={year:function(a){return Math.round((a+.5)*57/800+1954)}},width=800,height=502,xmin=1954,xmax=2010,ymin=0,ymax=500,vis=$(a).append("<canvas></canvas>").find("canvas"),company=$(".company"),context=vis[0].getContext("2d"),selected=null,type=d,p(),setTimeout(function(){r()},10)})()
